<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configuration</title>
  <link rel="stylesheet" href="/static/css/configuration.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

  <!-- üöÄ Barre de Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">üè† Econnect Home</a>
      <div class="navbar-nav">
        <a class="nav-link" href="/">Accueil</a>
        <a class="nav-link" href="/consommation">Consommation</a>
        <a class="nav-link" href="/etat_capteurs">√âtat des capteurs</a>
        <a class="nav-link" href="/economies">√âconomies</a>
        <a class="nav-link active" href="/configuration">Configuration</a>
      </div>
    </div>
  </nav>

  <!-- üè† Gestion des Logements -->
  <div class="container mt-5">
    <h2 class="text-center">üè† Gestion des Logements</h2>
    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#logementModal">‚ûï Ajouter un Logement</button>
    <ul class="list-group" id="logements-list"></ul>
  </div>

  <!-- üè¢ Gestion des Pi√®ces -->
  <div class="container mt-5">
    <h2 class="text-center">üè¢ Gestion des Pi√®ces</h2>
    <select id="logement-piece-selector" class="form-select mb-3">
      <option value="" disabled selected>-- S√©lectionnez un logement --</option>
    </select>
    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#pieceModal">‚ûï Ajouter une Pi√®ce</button>
    <ul class="list-group" id="pieces-list"></ul>
  </div>

  <!-- üì° Gestion des Capteurs -->
  <div class="container mt-5">
    <h2 class="text-center">üì° Gestion des Capteurs</h2>
    <select id="logement-capteur-selector" class="form-select mb-2">
      <option value="" disabled selected>-- S√©lectionnez un logement --</option>
    </select>
    <select id="piece-capteur-selector" class="form-select mb-3">
      <option value="" disabled selected>-- S√©lectionnez une pi√®ce --</option>
    </select>
    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#capteurModal">‚ûï Ajouter un Capteur</button>
    <ul class="list-group" id="capteurs-list"></ul>
  </div>

  <!-- üìù Modal Logement -->
  <div class="modal fade" id="logementModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajouter un Logement</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="adresse-logement" class="form-control mb-2" placeholder="Adresse">
                <input type="text" id="ip-logement" class="form-control mb-2" placeholder="Adresse IP">
                <input type="tel" id="telephone-logement" class="form-control mb-2" placeholder="Num√©ro de T√©l√©phone">
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="ajouterLogement()">Ajouter</button>
            </div>
        </div>
    </div>
  </div>

<!-- ‚úèÔ∏è Modal pour Modifier un Logement -->
<div class="modal fade" id="modifierLogementModal" tabindex="-1">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title">Modifier un Logement</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
              <input type="hidden" id="modifier-id-logement">
              <input type="text" id="modifier-adresse-logement" class="form-control mb-2" placeholder="Adresse">
              <input type="text" id="modifier-ip-logement" class="form-control mb-2" placeholder="Adresse IP">
              <input type="tel" id="modifier-telephone-logement" class="form-control mb-2" placeholder="Num√©ro de T√©l√©phone">
          </div>
          <div class="modal-footer">
              <button class="btn btn-success" onclick="modifierLogement()">Modifier</button>
          </div>
      </div>
  </div>
</div>



  <!-- üè¢ Modal Pi√®ce -->
  <div class="modal fade" id="pieceModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Ajouter une Pi√®ce</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="nom-piece" class="form-control mb-2" placeholder="Nom de la pi√®ce">
          <input type="number" id="coord-x" class="form-control mb-2" placeholder="Coordonn√©e X">
          <input type="number" id="coord-y" class="form-control mb-2" placeholder="Coordonn√©e Y">
          <input type="number" id="coord-z" class="form-control mb-2" placeholder="Coordonn√©e Z">
        </div>
        <div class="modal-footer">
          <button class="btn btn-success" onclick="ajouterPiece()">Ajouter</button>
        </div>
      </div>
    </div>
  </div>

  <!-- üì° Modal Capteur -->
  <div class="modal fade" id="capteurModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Ajouter un Capteur</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="nom-capteur" class="form-control mb-2" placeholder="Nom du Capteur">
          <input type="text" id="reference-commerciale" class="form-control mb-2" placeholder="R√©f√©rence Commerciale">
          <input type="text" id="port-capteur" class="form-control mb-2" placeholder="Port Communication">
          <select id="type-capteur" class="form-select mb-2">
              <option value="" disabled selected>-- S√©lectionnez un Type --</option>
          </select>
      </div>
      
        <div class="modal-footer">
          <button class="btn btn-success" onclick="ajouterCapteur()">Ajouter</button>
        </div>
      </div>
    </div>
  </div>
  

  <footer class="footer text-center py-3">
    <p>&copy; 2024 Econnect Home. Tous droits r√©serv√©s.</p>
  </footer>

  <script>
    // üè† Ajouter un Logement
function ajouterLogement() {
  const adresse = document.getElementById('adresse-logement').value;
  const ip = document.getElementById('ip-logement').value;
  const telephone = document.getElementById('telephone-logement').value;

  if (!adresse || !ip || !telephone) {
      alert('Veuillez remplir tous les champs.');
      return;
  }

  fetch('/api/logements', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
          adresse_postale: adresse,
          adresse_ip: ip,
          numero_telephone: telephone
      })
  })
  .then(response => response.json())
  .then(data => {
      console.log('Logement ajout√©:', data);
      $('#logementModal').modal('hide');
      chargerLogements();
  })
  .catch(error => console.error('Erreur lors de l\'ajout du logement:', error));
}

// üíæ Modifier un Logement
function modifierLogement() {
  const id = document.getElementById('modifier-id-logement').value;
  const adresse = document.getElementById('modifier-adresse-logement').value;
  const ip = document.getElementById('modifier-ip-logement').value;
  const telephone = document.getElementById('modifier-telephone-logement').value;

  if (!adresse || !ip || !telephone) {
      alert('Veuillez remplir tous les champs.');
      return;
  }

  fetch(`/api/logements/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
          adresse_postale: adresse,
          adresse_ip: ip,
          numero_telephone: telephone
      })
  })
  .then(response => {
      if (!response.ok) {
          throw new Error('Erreur lors de la modification du logement');
      }
      return response.json();
  })
  .then(data => {
      console.log('Logement modifi√©:', data);
      $('#modifierLogementModal').modal('hide');
      chargerLogements();
  })
  .catch(error => {
      console.error('Erreur lors de la modification du logement:', error);
  });
}




// ‚úèÔ∏è Ouvrir le Modal pour Modifier un Logement
function ouvrirModalModifierLogement(id, adresse, ip, telephone) {
  document.getElementById('modifier-id-logement').value = id;
  document.getElementById('modifier-adresse-logement').value = adresse;
  document.getElementById('modifier-ip-logement').value = ip;
  document.getElementById('modifier-telephone-logement').value = telephone;

  $('#modifierLogementModal').modal('show');
}



// üóëÔ∏è Supprimer un Logement
function supprimerLogement(id) {
  if (confirm('Voulez-vous vraiment supprimer ce logement ?')) {
      fetch(`/api/logements/${id}`, {
          method: 'DELETE'
      })
      .then(response => response.json())
      .then(() => {
          console.log('Logement supprim√©');
          chargerLogements();
      })
      .catch(error => console.error('Erreur lors de la suppression du logement:', error));
  }
}

function ajouterPiece() {
  const logementId = document.getElementById('logement-piece-selector').value;
  const nom = document.getElementById('nom-piece').value;
  const x = document.getElementById('coord-x').value;
  const y = document.getElementById('coord-y').value;
  const z = document.getElementById('coord-z').value;

  if (!logementId || !nom || !x || !y || !z) {
      alert('Veuillez remplir tous les champs.');
      return;
  }

  fetch('/api/pieces/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
          nom: nom,
          coord_x: parseInt(x),
          coord_y: parseInt(y),
          coord_z: parseInt(z),
          id_logement: parseInt(logementId)
      })
  })
  .then(response => response.json())
  .then(data => {
      console.log('Pi√®ce ajout√©e:', data);
      $('#pieceModal').modal('hide');
      chargerPieces(logementId);
  })
  .catch(error => console.error('Erreur lors de l\'ajout de la pi√®ce:', error));
}


// üì° Ajouter un Capteur
function ajouterCapteur() {
  const pieceId = document.getElementById('piece-capteur-selector').value;
  const nom = document.getElementById('nom-capteur').value;
  const referenceCommerciale = document.getElementById('reference-commerciale').value;
  const port = document.getElementById('port-capteur').value;
  const typeId = document.getElementById('type-capteur').value;

  if (!pieceId || !nom || !referenceCommerciale || !port || !typeId) {
      alert('Veuillez remplir tous les champs.');
      return;
  }

  fetch('/api/capteur_actionneur/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
          id_type: parseInt(typeId),
          nom: nom,
          reference_commerciale: referenceCommerciale,
          reference_piece: parseInt(pieceId),
          port_communication: port
      })
  })
  .then(response => {
      if (!response.ok) {
          throw new Error('Erreur lors de l\'ajout du capteur');
      }
      return response.json();
  })
  .then(data => {
      console.log('Capteur ajout√©:', data);
      $('#capteurModal').modal('hide');
      chargerCapteurs(pieceId);
  })
  .catch(error => {
      console.error('Erreur lors de l\'ajout du capteur:', error);
  });
}

// ‚úèÔ∏è Modifier une Pi√®ce
function modifierPiece(id) {
  const nom = prompt('Nouveau nom de la pi√®ce :');
  const x = prompt('Nouvelle coordonn√©e X :');
  const y = prompt('Nouvelle coordonn√©e Y :');
  const z = prompt('Nouvelle coordonn√©e Z :');

  if (!nom || !x || !y || !z) {
      alert('Veuillez remplir tous les champs.');
      return;
  }

  fetch(`/api/pieces/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
          nom: nom,
          coord_x: parseInt(x),
          coord_y: parseInt(y),
          coord_z: parseInt(z)
      })
  })
  .then(response => response.json())
  .then(data => {
      console.log('Pi√®ce modifi√©e:', data);
      chargerPieces(document.getElementById('logement-piece-selector').value);
  })
  .catch(error => console.error('Erreur lors de la modification de la pi√®ce:', error));
}

// üóëÔ∏è Supprimer une Pi√®ce
function supprimerPiece(id) {
  if (confirm('Voulez-vous vraiment supprimer cette pi√®ce ?')) {
      fetch(`/api/pieces/${id}`, {
          method: 'DELETE'
      })
      .then(response => response.json())
      .then(() => {
          console.log('Pi√®ce supprim√©e');
          chargerPieces(document.getElementById('logement-piece-selector').value);
      })
      .catch(error => console.error('Erreur lors de la suppression de la pi√®ce:', error));
  }
}




// üì• Charger les Logements
function chargerLogements() {
  fetch('/api/logements')
      .then(response => response.json())
      .then(data => {
          const logementsList = document.getElementById('logements-list');
          const logementPieceSelector = document.getElementById('logement-piece-selector');
          const logementCapteurSelector = document.getElementById('logement-capteur-selector');

          logementsList.innerHTML = '';
          logementPieceSelector.innerHTML = '<option value="" disabled selected>-- S√©lectionnez un logement --</option>';
          logementCapteurSelector.innerHTML = '<option value="" disabled selected>-- S√©lectionnez un logement --</option>';

          data.forEach(logement => {
              logementsList.innerHTML += `
                  <li class="list-group-item">
                      ${logement.adresse} (IP: ${logement.IP || 'Non d√©fini'}, Tel: ${logement.Tel || 'Non d√©fini'})
                      <button class="btn btn-warning btn-sm" 
                              onclick="ouvrirModalModifierLogement(${logement.id_logement}, '${logement.adresse}', '${logement.IP}', '${logement.Tel}')">
                              Modifier
                      </button>
                      <button class="btn btn-danger btn-sm" onclick="supprimerLogement(${logement.id_logement})">Supprimer</button>
                  </li>`;
              logementPieceSelector.innerHTML += `<option value="${logement.id_logement}">${logement.adresse}</option>`;
              logementCapteurSelector.innerHTML += `<option value="${logement.id_logement}">${logement.adresse}</option>`;
          });
      })
      .catch(error => console.error('Erreur lors du chargement des logements:', error));
}



// üì¶ Charger les Pi√®ces pour un logement s√©lectionn√©
function chargerPieces(logementId) {
  fetch(`/api/pieces?logement_id=${logementId}`)
      .then(response => response.json())
      .then(data => {
          const piecesList = document.getElementById('pieces-list');
          piecesList.innerHTML = '';

          data.forEach(piece => {
              piecesList.innerHTML += `
                  <li class="list-group-item">
                      ${piece.nom} (X: ${piece.coord_x}, Y: ${piece.coord_y}, Z: ${piece.coord_z})
                      <button class="btn btn-warning btn-sm" onclick="modifierPiece(${piece.id_piece})">Modifier</button>
                      <button class="btn btn-danger btn-sm" onclick="supprimerPiece(${piece.id_piece})">Supprimer</button>
                  </li>`;
          });
      })
      .catch(error => console.error('Erreur lors du chargement des pi√®ces:', error));
}


function chargerTypesCapteurs() {
  fetch('/api/types_capteurs_actionneurs')
    .then(response => response.json())
    .then(data => {
      const typeSelector = document.getElementById('type-capteur');
      typeSelector.innerHTML = '<option value="" disabled selected>-- S√©lectionnez un Type --</option>';
      data.forEach(type => {
        typeSelector.innerHTML += `<option value="${type.id_type_capteur_actionneur}">${type.nom_type}</option>`;
      });
    })
    .catch(error => console.error('Erreur lors du chargement des types de capteurs:', error));
}


document.addEventListener('DOMContentLoaded', () => {
  chargerLogements();
  chargerTypesCapteurs();
});

// üì¶ Charger les Pi√®ces pour un logement s√©lectionn√©
document.getElementById('logement-piece-selector').addEventListener('change', function () {
  const logementId = this.value;
  fetch(`/api/pieces?logement_id=${logementId}`)
      .then(response => response.json())
      .then(data => {
          const piecesList = document.getElementById('pieces-list');
          piecesList.innerHTML = '';

          data.forEach(piece => {
              piecesList.innerHTML += `
                  <li class="list-group-item">
                      ${piece.nom} (X: ${piece.coord_x}, Y: ${piece.coord_y}, Z: ${piece.coord_z})
                      <button class="btn btn-warning btn-sm" onclick="modifierPiece(${piece.id_piece})">Modifier</button>
                      <button class="btn btn-danger btn-sm" onclick="supprimerPiece(${piece.id_piece})">Supprimer</button>
                  </li>`;
          });
      })
      .catch(error => console.error('Erreur lors du chargement des pi√®ces:', error));
});

// üì° Charger les Pi√®ces pour les Capteurs
document.getElementById('logement-capteur-selector').addEventListener('change', function () {
  const logementId = this.value;
  const pieceSelector = document.getElementById('piece-capteur-selector');

  fetch(`/api/pieces?logement_id=${logementId}`)
      .then(response => response.json())
      .then(data => {
          pieceSelector.innerHTML = '<option value="" disabled selected>-- S√©lectionnez une pi√®ce --</option>';
          data.forEach(piece => {
              pieceSelector.innerHTML += `<option value="${piece.id_piece}">${piece.nom}</option>`;
          });
      })
      .catch(error => console.error('Erreur lors du chargement des pi√®ces pour capteurs:', error));
});

// üöÄ Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', chargerLogements);

  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
